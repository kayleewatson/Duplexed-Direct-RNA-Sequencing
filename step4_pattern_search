# start by just removing the obvious polyA reads
## THIS EXTRACTS SEQUENCES WITH 6 A's IN A ROW, WITH NO MISMATCHES. 
## THE PATTERN SEARCH PARAMETER CAN BE ALTERED FOR A MORE OR LESS STRINGENT SEARCH.
## HOWEVER, BE AWARE THAT SOME READS MAY HAVE SMALL STRETCHES OF BOTH A's AND U's

FASTA_FILTERED=filtered_fasta_from_step3
FUZZNUC_POLYA=fuzznuc_output_name_polya
FUZZNUC_POLYU=fuzznuc_output_name_polyu
POLYA_READS=filename_for_polyA_read_IDs
NON_POLYA_READS=filename_for_nonpolyA_read_IDs
NON_POLYA_FASTA=nonpolyA_fasta_name
POLYU_READS=filename_for_polyU_read_IDs
BAM=bam_file (same bam file from step 3)
POLYA_BAM=polya_filename.bam
POLYU_BAM=polyu_filename.bam

fuzznuc -sequence $FASTA_FILTERED -pattern 'A(6)' -outfile $FUZZNUC_POLYA
grep 'Sequence:' $FUZZNUC_POLYA | awk '{print $3}' > $POLYA_READS && rm $FUZZNUC_POLYA

# pull out read IDs for reads where polyA was not detected
grep '>' $FASTA_FILTERED | grep -vf $POLYA_READS | cut -c2- > $NON_POLYA_READS

grep --no-group-separator -A 1 -f $NON_POLYA_READS $FASTA_FILTERED > $NON_POLYA_FASTA
fuzznuc -sequence $NON_POLYA_FASTA -pattern 'T(6)' -outfile $FUZZNUC_POLYU
grep 'Sequence:' $FUZZNUC_POLYU | awk '{print $3}' > $POLYU_READS && rm $FUZZNUC_POLYU

# filter bam file for reads with polyA, then for reads with polyU
## if there are issues with this due to large file size, the bam file can be split prior to this step, then concatenated at the end
samtools view -H $BAM > header.txt
samtools view -h $BAM | grep -f $POLYA_READS > temp && cat header.txt temp | samtools view -bho $POLYA_BAM && rm temp
samtools view -h $BAM | grep -f $POLYU_READS > temp && cat header.txt temp | samtools view -bho $POLYU_BAM && rm temp
